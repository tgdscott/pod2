{% extends 'base.html' %}
{% block title %}New Template | PodcastPro{% endblock %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb mb-1">
                <li class="breadcrumb-item"><a href="/admin">Admin</a></li>
                <li class="breadcrumb-item"><a href="/admin/templates">Templates</a></li>
                <li class="breadcrumb-item active">New Template</a></li>
            </ol>
        </nav>
        <h2 class="mb-1">Create New Template</h2>
        <p class="text-muted mb-0">Design sophisticated episode structures with audio files and AI integration</p>
    </div>
    <a href="/admin/templates" class="btn btn-outline-secondary">
        <i class="fas fa-arrow-left me-2"></i>Back to Templates
    </a>
</div>

<div class="row">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-body">
                <form id="templateForm">
                    <!-- Basic Information -->
                    <div class="mb-4">
                        <h5>Basic Information</h5>
                        <div class="row g-3">
                            <div class="col-12">
                                <label for="name" class="form-label">Template Name *</label>
                                <input type="text" class="form-control" id="name" name="name" required>
                                <div class="form-text">A descriptive name for this template</div>
                            </div>
                            <div class="col-12">
                                <label for="description" class="form-label">Description</label>
                                <textarea class="form-control" id="description" name="description" rows="3" placeholder="Describe what this template is for..."></textarea>
                                <div class="form-text">Optional description of the template's purpose</div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="is_public" name="is_public">
                                    <label class="form-check-label" for="is_public">
                                        Make template public
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>



                    <!-- Episode Structure -->
                    <div class="mb-4">
                        <h5>Episode Structure</h5>
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            <strong>Pro Tip:</strong> Use the timeline below to arrange your segments. Audio files will automatically determine their duration, and you can set precise fade controls for music tracks.
                        </div>
                        
                        <div id="templateTimeline" class="border rounded p-3">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h6 class="mb-0">Timeline</h6>
                                <div class="btn-group btn-group-sm">
                                    <button type="button" class="btn btn-outline-primary" onclick="addSegment('intro')">
                                        <i class="fas fa-play me-1"></i>Intro
                                    </button>
                                    <button type="button" class="btn btn-outline-success" onclick="addSegment('content')">
                                        <i class="fas fa-microphone me-1"></i>Content
                                    </button>
                                    <button type="button" class="btn btn-outline-info" onclick="addSegment('transition')">
                                        <i class="fas fa-exchange-alt me-1"></i>Transition
                                    </button>
                                    <button type="button" class="btn btn-outline-warning" onclick="addSegment('outro')">
                                        <i class="fas fa-stop me-1"></i>Outro
                                    </button>
                                </div>
                            </div>
                            
                            <div id="segmentsTimeline">
                                <!-- Segments will be added here dynamically -->
                            </div>
                            
                            <div class="text-center mt-3">
                                <div class="timeline-ruler">
                                    <div class="ruler-markers">
                                        <span>0s</span>
                                        <span>30s</span>
                                        <span>1m</span>
                                        <span>1m 30s</span>
                                        <span>2m</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Music Track Configuration -->
                    <div class="mb-4">
                        <h5>Music Track Configuration</h5>
                        <div class="alert alert-warning">
                            <i class="fas fa-music me-2"></i>
                            <strong>Music Integration:</strong> Configure how background music interacts with your segments. Select from your uploaded files or upload new music.
                        </div>
                        
                        <div id="musicTracks">
                            <div class="card">
                                <div class="card-body">
                                    <div class="row g-3">
                                        <div class="col-md-6">
                                            <label class="form-label">Background Music</label>
                                            <select class="form-select" id="backgroundMusic" onchange="toggleMusicOptions()">
                                                <option value="">No background music</option>
                                                <option value="existing">Select from Existing Files</option>
                                                <option value="upload">Upload New Music</option>
                                            </select>
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label">Music File</label>
                                            <select class="form-select" id="musicFile" style="display: none;">
                                                <option value="">Select a music file...</option>
                                            </select>
                                            <input type="file" class="form-control" id="musicUpload" accept="audio/*" style="display: none;">
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label">Music Description</label>
                                            <input type="text" class="form-control" id="musicDescription" placeholder="e.g., Intro theme, Background music, Outro music">
                                            <div class="form-text">Helpful for shows with multiple music pieces</div>
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label">Music Start Point</label>
                                            <div class="input-group">
                                                <input type="number" class="form-control" id="musicStart" placeholder="0" min="0" step="0.1">
                                                <span class="input-group-text">seconds</span>
                                            </div>
                                            <div class="form-text">When the music should start playing</div>
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label">Music End Point</label>
                                            <div class="input-group">
                                                <input type="number" class="form-control" id="musicEnd" placeholder="Auto" min="0" step="0.1">
                                                <span class="input-group-text">seconds</span>
                                            </div>
                                            <div class="form-text">When the music should stop (leave empty for auto)</div>
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label">Fade In Duration</label>
                                            <div class="input-group">
                                                <input type="number" class="form-control" id="musicFadeIn" placeholder="0" min="0" step="0.1" value="0">
                                                <span class="input-group-text">seconds</span>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label">Fade Out Duration</label>
                                            <div class="input-group">
                                                <input type="number" class="form-control" id="musicFadeOut" placeholder="0" min="0" step="0.1" value="0">
                                                <span class="input-group-text">seconds</span>
                                            </div>
                                        </div>
                                        <div class="col-12">
                                            <div class="alert alert-secondary">
                                                <i class="fas fa-info-circle me-2"></i>
                                                <strong>Note:</strong> Fade controls will be configured in the timeline segments where you want the music to fade in or out.
                                            </div>
                                        </div>
                                        
                                        <!-- Music Timeline Visualization -->
                                        <div class="col-12" id="musicTimeline" style="display: none;">
                                            <h6>Music Timeline</h6>
                                            <div class="timeline-ruler">
                                                <div class="ruler-markers">
                                                    <span>0s</span>
                                                    <span>30s</span>
                                                    <span>1m</span>
                                                    <span>1m 30s</span>
                                                    <span>2m</span>
                                                </div>
                                            </div>
                                            <div class="music-track-visualization mt-2 p-2 bg-light border rounded">
                                                <small class="text-muted">Music will be applied across the entire episode duration</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- AI Voice Generation (ElevenLabs) -->
                    <div class="mb-4">
                        <h5>AI Voice Generation (ElevenLabs)</h5>
                        <div class="alert alert-info">
                            <i class="fas fa-robot me-2"></i>
                            <strong>How This Works:</strong> This section sets up AI voice generation for your podcast. When you create episodes, AI will automatically generate intro/outro voice content using your ElevenLabs API key. Perfect for consistent branding across episodes!
                        </div>
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            <strong>Note:</strong> You'll need to add your ElevenLabs API key in Settings first. This section is optional - you can skip it if you prefer to use only uploaded audio files.
                        </div>
                        
                        <div id="aiSegments">
                            <div class="card">
                                <div class="card-body">
                                    <div class="row g-3">
                                        <div class="col-md-6">
                                            <label class="form-label">Voice Model</label>
                                            <select class="form-select" id="voiceModel" onchange="toggleVoiceOptions()">
                                                <option value="">Select voice model...</option>
                                                <option value="custom">Use Custom Voice ID</option>
                                                <option value="21m00Tcm4TlvDq8ikWAM">Rachel (Professional)</option>
                                                <option value="AZnzlk1XvdvUeBnXmlld">Domi (Casual)</option>
                                                <option value="EXAVITQu4vr4xnSDxMaL">Bella (Warm)</option>
                                                <option value="21j0vfeTClDxlSDvGRl">Josh (Deep)</option>
                                            </select>
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label">Custom Voice ID</label>
                                            <input type="text" class="form-control" id="customVoiceId" placeholder="Enter your ElevenLabs Voice ID" style="display: none;">
                                            <div class="form-text" id="voiceIdHelp" style="display: none;">Find your Voice ID in your ElevenLabs dashboard</div>
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label">Voice Consistency</label>
                                            <div class="input-group">
                                                <input type="range" class="form-range" id="voiceStability" min="0" max="1" step="0.01" value="0.5">
                                                <span class="input-group-text">
                                                    <span id="stabilityLabel">Balanced</span>: <span id="stabilityValue">0.5</span>
                                                </span>
                                            </div>
                                            <div class="form-text">
                                                <strong>Low (0.0):</strong> More expressive, varies between generations<br>
                                                <strong>High (1.0):</strong> More consistent, same voice every time
                                            </div>
                                        </div>
                                        <div class="col-12">
                                            <label class="form-label">Dynamic Content Prompts</label>
                                            <div class="form-text mb-2">
                                                <i class="fas fa-lightbulb me-1"></i>
                                                <strong>Purpose:</strong> These are template prompts that will be used to generate dynamic content for each episode. 
                                                Use placeholders like [PODCAST_NAME], [TOPIC], [GUEST_NAME] that will be filled in when creating episodes.
                                                <br><strong>Example:</strong> "Welcome to [PODCAST_NAME], today we're discussing [TOPIC] with our special guest [GUEST_NAME]."
                                            </div>
                                            <div id="aiPrompts">
                                                <div class="input-group mb-2">
                                                    <input type="text" class="form-control" placeholder="e.g., Welcome to [PODCAST_NAME], today we're discussing [TOPIC]...">
                                                    <button type="button" class="btn btn-outline-danger" onclick="removePrompt(this)">
                                                        <i class="fas fa-trash"></i>
                                                    </button>
                                                </div>
                                            </div>
                                            <button type="button" class="btn btn-sm btn-outline-primary" onclick="addPrompt()">
                                                <i class="fas fa-plus me-1"></i>Add Prompt
                                            </button>
                                            <button type="button" class="btn btn-sm btn-outline-secondary ms-2" onclick="skipAISection()">
                                                <i class="fas fa-forward me-1"></i>Skip AI Section
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>



                    <!-- Submit Buttons -->
                    <div class="d-flex gap-2">
                        <button type="submit" class="btn btn-success btn-lg">
                            <i class="fas fa-save me-2"></i>Create Template
                        </button>
                        <button type="button" class="btn btn-outline-secondary btn-lg" onclick="window.location.href='/admin/templates'">
                            Cancel
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="col-lg-4">
        <!-- Help Card -->
        <div class="card mb-4">
            <div class="card-header">
                <h6 class="mb-0"><i class="fas fa-info-circle me-2"></i>Template Guide</h6>
            </div>
            <div class="card-body">
                <h6>Advanced Template Features:</h6>
                <ul class="small">
                    <li class="mb-2"><strong>Main Audio:</strong> Your primary episode content</li>
                    <li class="mb-2"><strong>Audio Segments:</strong> Intro, outro, transitions from your files</li>
                    <li class="mb-2"><strong>Music Integration:</strong> Background music with custom timing</li>
                    <li class="mb-2"><strong>AI Voice:</strong> Generate dynamic content with ElevenLabs</li>
                </ul>
                
                <h6>Segment Types:</h6>
                <ul class="small">
                    <li><strong>Intro:</strong> Opening music, show intro, welcome message</li>
                    <li><strong>Content:</strong> Main episode content (your primary audio)</li>
                    <li><strong>Outro:</strong> Closing music, call-to-action, goodbye</li>
                    <li><strong>Transition:</strong> Short music beds for commercial breaks or scene changes</li>
                </ul>
                
                <h6>How It Works:</h6>
                <ul class="small">
                    <li>Templates define the structure and timing</li>
                    <li>When creating episodes, you'll add your main content</li>
                    <li>Music and effects are applied based on this template</li>
                </ul>
                
                <h6>AI Integration:</h6>
                <ul class="small">
                    <li>Use AI for intro/outro voice generation</li>
                    <li>AI segments use your ElevenLabs API key</li>
                    <li>Perfect for consistent branding across episodes</li>
                </ul>
            </div>
        </div>

        <!-- Quick Templates -->
        <div class="card mb-4">
            <div class="card-header">
                <h6 class="mb-0"><i class="fas fa-bolt me-2"></i>Quick Templates</h6>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <button class="btn btn-outline-primary btn-sm" onclick="loadQuickTemplate('professional')">
                        Professional Show
                    </button>
                    <button class="btn btn-outline-primary btn-sm" onclick="loadQuickTemplate('casual')">
                        Casual Conversation
                    </button>
                    <button class="btn btn-outline-primary btn-sm" onclick="loadQuickTemplate('story')">
                        Story Format
                    </button>
                </div>
            </div>
        </div>

        <!-- Template Preview -->
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0"><i class="fas fa-eye me-2"></i>Template Preview</h6>
            </div>
            <div class="card-body">
                <div id="templatePreview">
                    <p class="text-muted small">Template preview will appear here as you build it.</p>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.timeline-ruler {
    position: relative;
    height: 30px;
    background: #f8f9fa;
    border-top: 1px solid #dee2e6;
}

.ruler-markers {
    display: flex;
    justify-content: space-between;
    padding: 5px 10px;
    font-size: 12px;
    color: #6c757d;
}

.segment-item {
    border: 1px solid #dee2e6;
    border-radius: 8px;
    margin-bottom: 10px;
    background: white;
}

.segment-header {
    background: #f8f9fa;
    padding: 10px;
    border-bottom: 1px solid #dee2e6;
    border-radius: 8px 8px 0 0;
}

.segment-content {
    padding: 15px;
}

.audio-file-item {
    background: #e9ecef;
    border-radius: 4px;
    padding: 8px;
    margin-bottom: 8px;
    display: flex;
    justify-content: between;
    align-items: center;
}

.audio-file-item .file-info {
    flex: 1;
}

.audio-file-item .file-actions {
    display: flex;
    gap: 5px;
}

.timing-controls {
    background: #f8f9fa;
    border-radius: 4px;
    padding: 10px;
    margin-top: 10px;
}

.fade-controls {
    border-left: 3px solid #007bff;
    padding-left: 10px;
    margin-top: 10px;
}
</style>

<script>
let authToken = '{{ token }}'; // Get token from server
let segmentCounter = 0;
let uploadedFiles = [];
let currentTemplate = {
    name: '',
    description: '',
    segments: [],
    musicTrack: null,
    aiSegments: []
};

// Debug token
console.log('Auth token received:', authToken ? 'Present' : 'Missing');
console.log('Token length:', authToken ? authToken.length : 0);

// Check if we have a valid token
if (!authToken || authToken === 'None' || authToken === '') {
    console.error('No authentication token available');
    alert('Authentication required. Please log in again.');
    window.location.href = '/login';
}

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    updateTemplatePreview();
    loadExistingFiles();
    
    // Voice stability slider
    document.getElementById('voiceStability').addEventListener('input', function() {
        const value = parseFloat(this.value);
        document.getElementById('stabilityValue').textContent = value.toFixed(2);
        
        let label = 'Balanced';
        if (value < 0.3) label = 'Very Expressive';
        else if (value < 0.6) label = 'Balanced';
        else label = 'Very Consistent';
        
        document.getElementById('stabilityLabel').textContent = label;
    });
});

function loadExistingFiles() {
    console.log('Loading existing files with token:', authToken ? 'Present' : 'Missing');
    
    // Load existing audio files from the API
    fetch('/api/v1/files/', {
        headers: {
            'Authorization': `Bearer ${authToken}`
        }
    })
    .then(response => {
        console.log('Files API response status:', response.status);
        return response.json();
    })
    .then(data => {
        console.log('Files API response:', data);
        if (data.success) {
            uploadedFiles = data.files;
            updateFileDropdowns();
            updateAllSegmentFileLists();
        } else {
            console.error('Files API error:', data.error);
        }
    })
    .catch(error => {
        console.error('Error loading files:', error);
    });
}

function updateAllSegmentFileLists() {
    // Update file lists for all existing segments
    document.querySelectorAll('.segment-item').forEach(segment => {
        const segmentType = segment.getAttribute('data-segment-type');
        const audioSelect = segment.querySelector('.segment-audio');
        const currentValue = audioSelect.value;
        
        if (segmentType) {
            const filteredFiles = getFilteredFilesForType(segmentType);
            audioSelect.innerHTML = '<option value="">Select an audio file...</option>';
            
            filteredFiles.forEach(file => {
                const option = document.createElement('option');
                option.value = file.path;
                option.textContent = `${file.db_name || file.filename} (${file.duration || 'Unknown'}s)`;
                if (file.path === currentValue) {
                    option.selected = true;
                }
                audioSelect.appendChild(option);
            });
        }
    });
}

function updateFileDropdowns() {
    // Update main audio dropdown - show all files for main content
    const mainAudioSelect = document.getElementById('mainAudioFile');
    mainAudioSelect.innerHTML = '<option value="">Select an audio file...</option>';
    uploadedFiles.forEach(file => {
        const option = document.createElement('option');
        option.value = file.path;
        option.textContent = `${file.db_name || file.filename} (${file.duration || 'Unknown'}s)`;
        mainAudioSelect.appendChild(option);
    });
    
    // Update music dropdown - filter for music files
    const musicSelect = document.getElementById('musicFile');
    musicSelect.innerHTML = '<option value="">Select a music file...</option>';
    const musicFiles = uploadedFiles.filter(file => {
        const fileCategory = file.category ? file.category.toLowerCase() : '';
        const fileName = file.db_name ? file.db_name.toLowerCase() : '';
        const fileDesc = file.description ? file.description.toLowerCase() : '';
        
        return fileCategory.includes('music') || 
               fileName.includes('music') || 
               fileDesc.includes('music') ||
               fileCategory.includes('background') ||
               fileName.includes('background') ||
               fileDesc.includes('background') ||
               fileCategory.includes('bed') ||
               fileName.includes('bed') ||
               fileDesc.includes('bed');
    });
    
    musicFiles.forEach(file => {
        const option = document.createElement('option');
        option.value = file.path;
        option.textContent = `${file.db_name || file.filename} (${file.duration || 'Unknown'}s)`;
        musicSelect.appendChild(option);
    });
}



function toggleMusicOptions() {
    const source = document.getElementById('backgroundMusic').value;
    const fileSelect = document.getElementById('musicFile');
    const fileUpload = document.getElementById('musicUpload');
    const musicTimeline = document.getElementById('musicTimeline');
    
    fileSelect.style.display = 'none';
    fileUpload.style.display = 'none';
    musicTimeline.style.display = 'none';
    
    if (source === 'existing') {
        fileSelect.style.display = 'block';
        musicTimeline.style.display = 'block';
    } else if (source === 'upload') {
        fileUpload.style.display = 'block';
        musicTimeline.style.display = 'block';
    }
}

function toggleVoiceOptions() {
    const model = document.getElementById('voiceModel').value;
    const customInput = document.getElementById('customVoiceId');
    const helpText = document.getElementById('voiceIdHelp');
    
    if (model === 'custom') {
        customInput.style.display = 'block';
        helpText.style.display = 'block';
    } else {
        customInput.style.display = 'none';
        helpText.style.display = 'none';
    }
}

function addSegment(type) {
    console.log('Adding segment of type:', type);
    
    segmentCounter++;
    const segmentsTimeline = document.getElementById('segmentsTimeline');
    
    const segmentHtml = `
        <div class="segment-item" data-segment-id="${segmentCounter}" data-segment-type="${type}">
            <div class="segment-header d-flex justify-content-between align-items-center">
                <div>
                    <h6 class="mb-0">
                        <i class="fas fa-${getSegmentIcon(type)} me-2"></i>
                        ${type.charAt(0).toUpperCase() + type.slice(1)} Segment ${segmentCounter}
                    </h6>
                </div>
                <div class="btn-group btn-group-sm">
                    <button type="button" class="btn btn-outline-secondary" onclick="moveSegment(${segmentCounter}, 'up')" title="Move Up">
                        <i class="fas fa-arrow-up"></i> Up
                    </button>
                    <button type="button" class="btn btn-outline-secondary" onclick="moveSegment(${segmentCounter}, 'down')" title="Move Down">
                        <i class="fas fa-arrow-down"></i> Down
                    </button>
                    <button type="button" class="btn btn-outline-danger" onclick="removeSegment(${segmentCounter})" title="Delete Segment">
                        <i class="fas fa-trash"></i> Delete
                    </button>
                </div>
            </div>
            <div class="segment-content">
                <div class="row g-3">
                    <div class="col-md-6 segment-audio-source-container">
                        <label class="form-label">Audio Source</label>
                        <select class="form-select segment-audio-source" onchange="toggleSegmentAudioOptions(${segmentCounter})">
                            <option value="">No audio</option>
                            <option value="file">Select from files</option>
                            <option value="ai">Generate with AI</option>
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Audio File</label>
                        <select class="form-select segment-audio" onchange="updateSegmentDuration(${segmentCounter})" style="display: none;">
                            <option value="">Select an audio file...</option>
                            ${getFilteredFilesForType(type).map(file => `<option value="${file.path}">${file.db_name || file.filename} (${file.duration || 'Unknown'}s)</option>`).join('')}
                        </select>
                        <div class="segment-content-note" style="display: none;">
                            <small class="text-muted">
                                <i class="fas fa-info-circle me-1"></i>
                                Content segments will use your episode audio when creating episodes
                            </small>
                        </div>
                        <div class="segment-ai-options" style="display: none;">
                            <div class="row g-2">
                                <div class="col-12">
                                    <label class="form-label small">Voice Selection</label>
                                    <select class="form-select segment-voice" onchange="updateVoicePreview(${segmentCounter})">
                                        <option value="">Loading voices...</option>
                                    </select>
                                </div>
                                <div class="col-12">
                                    <label class="form-label small">AI Prompt Template</label>
                                    <div class="input-group">
                                        <input type="text" class="form-control segment-ai-prompt" placeholder="e.g., Welcome to [PODCAST_NAME], today we're discussing [TOPIC]...">
                                        <button type="button" class="btn btn-outline-secondary" onclick="previewAISegment(${segmentCounter})">
                                            <i class="fas fa-play"></i>
                                        </button>
                                    </div>
                                    <div class="form-text small">
                                        <i class="fas fa-info-circle me-1"></i>
                                        Use placeholders like [PODCAST_NAME], [TOPIC], [GUEST_NAME] that will be filled in when creating episodes.
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Duration</label>
                        <div class="input-group">
                            <input type="text" class="form-control segment-duration" readonly>
                            <span class="input-group-text">seconds</span>
                        </div>
                    </div>
                    <div class="col-md-8">
                        <label class="form-label">Description</label>
                        <input type="text" class="form-control segment-description" placeholder="Brief description of this segment">
                    </div>
                    
                    <!-- Fade Controls for Music and Transition Segments -->
                    <div class="col-12 segment-fade-controls" style="display: none;">
                        <div class="card">
                            <div class="card-body">
                                <h6 class="card-title">Fade Controls</h6>
                                <div class="row g-2">
                                    <div class="col-md-6">
                                        <label class="form-label small">Fade In Duration</label>
                                        <div class="input-group input-group-sm">
                                            <input type="number" class="form-control" placeholder="0" min="0" step="0.1" value="0">
                                            <span class="input-group-text">s</span>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label small">Fade Out Duration</label>
                                        <div class="input-group input-group-sm">
                                            <input type="number" class="form-control" placeholder="0" min="0" step="0.1" value="0">
                                            <span class="input-group-text">s</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    segmentsTimeline.insertAdjacentHTML('beforeend', segmentHtml);
    
    // Hide audio source for content segments and show helpful note
    if (type === 'content') {
        const segment = document.querySelector(`[data-segment-id="${segmentCounter}"]`);
        const audioSourceContainer = segment.querySelector('.segment-audio-source-container');
        const contentNote = segment.querySelector('.segment-content-note');
        if (audioSourceContainer) {
            audioSourceContainer.style.display = 'none';
        }
        if (contentNote) {
            contentNote.style.display = 'block';
        }
    }
    
    updateTemplatePreview();
}

function getSegmentIcon(type) {
    const icons = {
        'intro': 'play',
        'content': 'microphone',
        'transition': 'exchange-alt',
        'outro': 'stop'
    };
    return icons[type] || 'music';
}

function getFilteredFilesForType(segmentType) {
    // Filter files based on segment type
    return uploadedFiles.filter(file => {
        const fileCategory = file.category ? file.category.toLowerCase() : '';
        const fileName = file.db_name ? file.db_name.toLowerCase() : '';
        const fileDesc = file.description ? file.description.toLowerCase() : '';
        
        switch(segmentType) {
            case 'intro':
                return fileCategory.includes('intro') || 
                       fileName.includes('intro') || 
                       fileDesc.includes('intro') ||
                       fileCategory.includes('opening') ||
                       fileName.includes('opening') ||
                       fileDesc.includes('opening');
            
            case 'outro':
                return fileCategory.includes('outro') || 
                       fileName.includes('outro') || 
                       fileDesc.includes('outro') ||
                       fileCategory.includes('closing') ||
                       fileName.includes('closing') ||
                       fileDesc.includes('closing') ||
                       fileCategory.includes('ending') ||
                       fileName.includes('ending') ||
                       fileDesc.includes('ending');
            
            case 'transition':
                return fileCategory.includes('transition') || 
                       fileName.includes('transition') || 
                       fileDesc.includes('transition') ||
                       fileCategory.includes('music') ||
                       fileName.includes('music') ||
                       fileDesc.includes('music') ||
                       fileCategory.includes('bed') ||
                       fileName.includes('bed') ||
                       fileDesc.includes('bed');
            
            case 'content':
                // Content can use any file type, but prioritize content files
                return fileCategory.includes('content') || 
                       fileName.includes('content') || 
                       fileDesc.includes('content') ||
                       fileCategory.includes('main') ||
                       fileName.includes('main') ||
                       fileDesc.includes('main') ||
                       true; // Allow all files for content segments
            
            default:
                return true; // Show all files for unknown types
        }
    });
}

function removeSegment(segmentId) {
    const segment = document.querySelector(`[data-segment-id="${segmentId}"]`);
    if (segment) {
        segment.remove();
        updateTemplatePreview();
    }
}

function moveSegment(segmentId, direction) {
    const segment = document.querySelector(`[data-segment-id="${segmentId}"]`);
    const timeline = document.getElementById('segmentsTimeline');
    
    if (direction === 'up' && segment.previousElementSibling) {
        timeline.insertBefore(segment, segment.previousElementSibling);
    } else if (direction === 'down' && segment.nextElementSibling) {
        timeline.insertBefore(segment.nextElementSibling, segment);
    }
    
    updateTemplatePreview();
}

function toggleSegmentAudioOptions(segmentId) {
    const segment = document.querySelector(`[data-segment-id="${segmentId}"]`);
    const audioSource = segment.querySelector('.segment-audio-source');
    const audioSelect = segment.querySelector('.segment-audio');
    const aiOptions = segment.querySelector('.segment-ai-options');
    const durationInput = segment.querySelector('.segment-duration');
    const fadeControls = segment.querySelector('.segment-fade-controls');
    
    // Hide both options initially
    audioSelect.style.display = 'none';
    aiOptions.style.display = 'none';
    durationInput.value = '';
    
    if (audioSource.value === 'file') {
        audioSelect.style.display = 'block';
        // Show fade controls for music/transition segments
        const segmentType = segment.querySelector('h6').textContent.split(' ')[0].toLowerCase();
        if (segmentType === 'music' || segmentType === 'transition') {
            fadeControls.style.display = 'block';
        }
    } else if (audioSource.value === 'ai') {
        aiOptions.style.display = 'block';
        durationInput.value = 'AI Generated';
        // Load voices for AI segments
        loadVoicesForSegment(segmentId);
    }
}

function updateSegmentDuration(segmentId) {
    const segment = document.querySelector(`[data-segment-id="${segmentId}"]`);
    const audioSelect = segment.querySelector('.segment-audio');
    const durationInput = segment.querySelector('.segment-duration');
    const descriptionInput = segment.querySelector('.segment-description');
    
    if (audioSelect.value) {
        const selectedFile = uploadedFiles.find(file => file.path === audioSelect.value);
        if (selectedFile) {
            durationInput.value = selectedFile.duration || 'Unknown';
            
            // Auto-populate description from file description (not metadata)
            if (!descriptionInput.value.trim()) {
                descriptionInput.value = selectedFile.description || selectedFile.db_name || selectedFile.filename;
            }
        }
    } else {
        durationInput.value = '';
    }
}

function loadVoicesForSegment(segmentId) {
    const segment = document.querySelector(`[data-segment-id="${segmentId}"]`);
    const voiceSelect = segment.querySelector('.segment-voice');
    
    fetch('/api/v1/voices/', {
        headers: {
            'Authorization': `Bearer ${authToken}`
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            voiceSelect.innerHTML = '<option value="">Select a voice...</option>';
            
            data.voices.forEach(voice => {
                const option = document.createElement('option');
                option.value = voice.voice_id;
                option.textContent = `${voice.name} (${voice.category})`;
                voiceSelect.appendChild(option);
            });
            
            // Set default voice if available
            loadDefaultVoiceForSegment(segmentId);
        }
    })
    .catch(error => {
        console.error('Error loading voices:', error);
        voiceSelect.innerHTML = '<option value="">Error loading voices</option>';
    });
}

function loadDefaultVoiceForSegment(segmentId) {
    fetch('/api/v1/settings/default-voice', {
        headers: {
            'Authorization': `Bearer ${authToken}`
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success && data.settings && data.settings.voice_id) {
            const segment = document.querySelector(`[data-segment-id="${segmentId}"]`);
            const voiceSelect = segment.querySelector('.segment-voice');
            voiceSelect.value = data.settings.voice_id;
        }
    })
    .catch(error => {
        console.error('Error loading default voice:', error);
    });
}

function updateVoicePreview(segmentId) {
    const segment = document.querySelector(`[data-segment-id="${segmentId}"]`);
    const voiceSelect = segment.querySelector('.segment-voice');
    const selectedVoice = voiceSelect.options[voiceSelect.selectedIndex];
    
    if (selectedVoice && selectedVoice.value) {
        console.log(`Voice selected for segment ${segmentId}: ${selectedVoice.textContent}`);
    }
}

function previewAISegment(segmentId) {
    const segment = document.querySelector(`[data-segment-id="${segmentId}"]`);
    const promptInput = segment.querySelector('.segment-ai-prompt');
    const voiceSelect = segment.querySelector('.segment-voice');
    const prompt = promptInput.value.trim();
    const voiceId = voiceSelect.value;
    
    if (!prompt) {
        alert('Please enter a prompt for the AI segment');
        return;
    }
    
    if (!voiceId) {
        alert('Please select a voice for the AI segment');
        return;
    }
    
    // This would integrate with ElevenLabs API
    alert(`AI preview functionality will be implemented when creating episodes.\n\nVoice: ${voiceSelect.options[voiceSelect.selectedIndex].textContent}\nPrompt: ${prompt}`);
}

function addPrompt() {
    const promptsContainer = document.getElementById('aiPrompts');
    const promptHtml = `
        <div class="input-group mb-2">
            <input type="text" class="form-control" placeholder="e.g., Welcome to [PODCAST_NAME], today we're discussing [TOPIC]...">
            <button type="button" class="btn btn-outline-danger" onclick="removePrompt(this)">
                <i class="fas fa-trash"></i>
            </button>
        </div>
    `;
    promptsContainer.insertAdjacentHTML('beforeend', promptHtml);
}

function removePrompt(button) {
    button.closest('.input-group').remove();
}

function skipAISection() {
    if (confirm('Skip AI Voice Generation? You can always configure this later in Settings.')) {
        // Clear AI fields
        document.getElementById('voiceModel').value = '';
        document.getElementById('customVoiceId').value = '';
        document.getElementById('voiceStability').value = '0.5';
        document.getElementById('aiPrompts').innerHTML = `
            <div class="input-group mb-2">
                <input type="text" class="form-control" placeholder="e.g., Welcome to [PODCAST_NAME], today we're discussing [TOPIC]...">
                <button type="button" class="btn btn-outline-danger" onclick="removePrompt(this)">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        `;
        alert('AI Voice Generation skipped. You can configure this later in Settings.');
    }
}

function updateTemplatePreview() {
    const preview = document.getElementById('templatePreview');
    const segments = document.querySelectorAll('.segment-item');
    
    if (segments.length === 0) {
        preview.innerHTML = '<p class="text-muted small">Template preview will appear here as you build it.</p>';
        return;
    }
    
    let previewHtml = '<div class="small">';
    segments.forEach((segment, index) => {
        const segmentType = segment.getAttribute('data-segment-type');
        const type = segment.querySelector('h6').textContent.split(' ')[0];
        const description = segment.querySelector('.segment-description').value || 'No description';
        const audioSource = segment.querySelector('.segment-audio-source').value;
        
        let audioInfo = '❌ No Audio';
        if (segmentType === 'content') {
            audioInfo = '🎙️ Episode Content';
        } else if (audioSource === 'file') {
            audioInfo = '📁 File';
        } else if (audioSource === 'ai') {
            audioInfo = '🤖 AI Generated';
        }
        
        previewHtml += `
            <div class="mb-2 p-2 border rounded">
                <strong>${index + 1}. ${type}</strong><br>
                <span class="text-muted">${description}</span><br>
                <small class="text-info">${audioInfo}</small>
            </div>
        `;
    });
    previewHtml += '</div>';
    
    preview.innerHTML = previewHtml;
}

function loadQuickTemplate(type) {
    // Clear existing segments
    document.getElementById('segmentsTimeline').innerHTML = '';
    segmentCounter = 0;
    
    switch(type) {
        case 'professional':
            addSegment('intro');
            addSegment('content');
            addSegment('outro');
            break;
        case 'casual':
            addSegment('intro');
            addSegment('content');
            addSegment('outro');
            break;
        case 'story':
            addSegment('intro');
            addSegment('content');
            addSegment('outro');
            break;
    }
    
    updateTemplatePreview();
}

// Form submission
document.getElementById('templateForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    // Validate form
    const name = document.getElementById('name').value.trim();
    if (!name) {
        alert('Template name is required');
        return;
    }
    
    // Collect form data in the format expected by the API
    const formData = {
        name: name,
        description: document.getElementById('description').value.trim(),
        is_public: document.getElementById('is_public').checked,
        content: {
            version: '2.0.0',
            main_audio: {
                source: document.getElementById('mainAudioSource') ? document.getElementById('mainAudioSource').value : '',
                file: document.getElementById('mainAudioSource') && document.getElementById('mainAudioSource').value === 'existing' ? 
                      (document.getElementById('mainAudioFile') ? document.getElementById('mainAudioFile').value : null) : null
            },
            music: {
                enabled: document.getElementById('backgroundMusic') ? document.getElementById('backgroundMusic').value !== '' : false,
                source: document.getElementById('backgroundMusic') ? document.getElementById('backgroundMusic').value : '',
                file: document.getElementById('backgroundMusic') && document.getElementById('backgroundMusic').value === 'existing' ? 
                      (document.getElementById('musicFile') ? document.getElementById('musicFile').value : null) : null,
                description: document.getElementById('musicDescription') ? document.getElementById('musicDescription').value : '',
                start_point: document.getElementById('musicStart') ? parseFloat(document.getElementById('musicStart').value) || 0 : 0,
                end_point: document.getElementById('musicEnd') && document.getElementById('musicEnd').value ? parseFloat(document.getElementById('musicEnd').value) : null,
                fade_in: document.getElementById('musicFadeIn') ? parseFloat(document.getElementById('musicFadeIn').value) || 0 : 0,
                fade_out: document.getElementById('musicFadeOut') ? parseFloat(document.getElementById('musicFadeOut').value) || 0 : 0
            },
            voice: {
                model: document.getElementById('voiceModel') ? document.getElementById('voiceModel').value : '',
                custom_id: document.getElementById('customVoiceId') ? document.getElementById('customVoiceId').value : '',
                stability: document.getElementById('voiceStability') ? parseFloat(document.getElementById('voiceStability').value) || 0.5 : 0.5
            },
            segments: []
        }
    };
    
    // Collect segments
    document.querySelectorAll('.segment-item').forEach(segment => {
        const audioSource = segment.querySelector('.segment-audio-source').value;
        const segmentType = segment.querySelector('h6').textContent.split(' ')[0].toLowerCase();
        const fadeControls = segment.querySelector('.segment-fade-controls');
        
        const segmentData = {
            type: segmentType,
            audio_source: audioSource,
            audio_file: audioSource === 'file' ? segment.querySelector('.segment-audio').value : null,
            ai_prompt: audioSource === 'ai' ? segment.querySelector('.segment-ai-prompt').value : null,
            ai_voice_id: audioSource === 'ai' ? segment.querySelector('.segment-voice').value : null,
            description: segment.querySelector('.segment-description').value || ''
        };
        
        // Add fade controls for music and transition segments
        if ((segmentType === 'music' || segmentType === 'transition') && fadeControls && fadeControls.style.display !== 'none') {
            const fadeInputs = fadeControls.querySelectorAll('input[type="number"]');
            segmentData.fade_in = parseFloat(fadeInputs[0].value) || 0;
            segmentData.fade_out = parseFloat(fadeInputs[1].value) || 0;
        }
        
        formData.content.segments.push(segmentData);
    });
    
    // Collect AI prompts
    const prompts = [];
    document.querySelectorAll('#aiPrompts input').forEach(input => {
        if (input.value.trim()) {
            prompts.push(input.value.trim());
        }
    });
    formData.content.voice.prompts = prompts;
    
    console.log('Submitting template data:', formData);
    
    // Submit to API
    fetch('/api/v1/templates/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${authToken}`
        },
        body: JSON.stringify(formData)
    })
    .then(response => {
        console.log('Response status:', response.status);
        return response.json();
    })
    .then(data => {
        console.log('Response data:', data);
        if (data.message) {
            alert('Template created successfully!');
            window.location.href = '/admin/templates';
        } else {
            // Show specific error message
            const errorMsg = data.error || 'Unknown error';
            alert('Error creating template: ' + errorMsg);
            console.error('Template creation failed:', data);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error creating template. Please check your internet connection and try again.');
    });
});
</script>
{% endblock %} 